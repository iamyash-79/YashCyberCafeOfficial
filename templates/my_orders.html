<!DOCTYPE html>
<html lang="en" x-data="myOrdersApp()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Orders - {{ short_name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col md:flex-row">
  {% include 'sidebar.html' %}

  <!-- Hidden UPI link (used for mobile redirection) -->
  <a id="upi-link" class="hidden" target="_blank">Pay Now</a>

  <main class="flex-1 p-4 sm:p-6 bg-white rounded-lg shadow-md">
    <h1 class="text-2xl sm:text-3xl font-bold mb-6 mt-16">My Orders</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-4">
          {% for category, message in messages %}
            <div class="p-3 rounded text-white 
              {% if category == 'success' %}bg-green-600{% elif category == 'error' %}bg-red-600{% else %}bg-blue-600{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="overflow-x-auto bg-white rounded-lg shadow p-4">
      <table class="min-w-full text-sm sm:text-base text-center table-auto">
        <thead class="border-b bg-gray-100">
          <tr>
            <th class="p-2">S.No.</th>
            <th class="p-2">Item</th>
            <th class="p-2">Quantity</th>
            <th class="p-2">Amount</th>
            <th class="p-2">Status</th>
            <th class="p-2" style="min-width: 300px;">Address</th>
            <th class="p-2">Order Date & Time</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for order in my_orders %}
          <tr class="border-b hover:bg-gray-50">
            <td class="p-2">{{ loop.index }}</td>
            <td class="p-2">{{ order.item_name }}</td>
            <td class="p-2">{{ order.quantity }}</td>
            <td class="p-2">₹{{ '%.2f' % order.amount }}</td>
            <td class="p-2 capitalize">
              <span class="{% if order.status == 'pending' %}text-yellow-600
                            {% elif order.status == 'accepted' %}text-green-600
                            {% elif order.status == 'cancelled' %}text-red-600
                            {% elif order.status == 'delivered' %}text-blue-600
                            {% else %}text-gray-600{% endif %}">
                {{ order.status }}
              </span>
            </td>
            <td x-data="{ expanded: false }" class="p-2 max-w-[300px] text-left">
              <template x-if="expanded">
                <span>
                  {{ order.address1 }}{% if order.address2 %}, {{ order.address2 }}{% endif %}, {{ order.city }}, {{ order.pincode }}
                </span>
              </template>
              <template x-if="!expanded">
                <span>
                  {{ order.address1 | truncate(40, False, '') }}
                  <span @click="expanded = true" class="text-blue-600 cursor-pointer hover:underline">...</span>
                </span>
              </template>
            </td>
            <td class="p-2">
              {% set dt = order.order_date.split(' ') %}
              <div>{{ dt[0] }}</div>
              <div>{{ dt[1] if dt|length > 1 else '' }}</div>
            </td>
            <td class="p-2">
              <div class="flex flex-col items-center space-y-2">
                {% if order.status == 'pending' or (order.status == 'accepted' and not order.is_paid) %}
                  <button @click="handlePayment({{ order.id }}, {{ '%.2f' % order.amount }})" class="text-blue-600 hover:underline">Pay Now</button>
                  <form method="POST" action="{{ url_for('cancel_order', order_id=order.id) }}" @submit.prevent="openCancelModal($event)">
                    <button type="submit" class="text-red-600 hover:underline">Cancel</button>
                  </form>
                {% elif order.is_paid %}
                  <button @click="openReceipt({{ order.id }}, '{{ user.name }}', '{{ order.amount }}', '{{ order.order_date }}')" class="text-green-600 hover:underline font-semibold">Paid</button>
                {% elif order.status == 'delivered' %}
                  <span class="text-blue-600 font-semibold">Delivered ✅</span>
                {% else %}
                  <span class="text-gray-400">No actions</span>
                {% endif %}
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="text-center p-4 text-gray-500">No orders found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- QR Modal -->
    <div x-show="showQR" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" x-cloak>
      <div class="bg-white p-4 rounded-lg shadow-md w-80">
        <h2 class="text-xl font-bold mb-2">Scan to Pay ₹<span x-text="qrAmount"></span></h2>
        <img :src="qrImage" alt="UPI QR Code" class="w-full rounded mb-4" />
        <button @click="showQR = false" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">Close</button>
      </div>
    </div>

    <!-- Cancel Modal -->
    <div x-show="showCancelModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4 text-center">
        <h2 class="text-lg font-semibold mb-4">Confirm Cancellation</h2>
        <p class="mb-6">Are you sure you want to cancel this order?<br><span class="font-bold text-red-600">This action cannot be undone.</span></p>
        <div class="flex justify-center space-x-4">
          <button @click="closeCancelModal()" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">No, Keep</button>
          <button @click="submitCancelForm()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Yes, Cancel</button>
        </div>
      </div>
    </div>
  </main>

  <script>
    function myOrdersApp() {
      return {
        showQR: false,
        qrAmount: '',
        qrImage: '',
        showCancelModal: false,
        cancelForm: null,

        handlePayment(orderId, amount) {
          const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
          const upiURL = `upi://pay?pa=syashwant682-7@oksbi&pn=Yashwant%20Sahu&am=${amount.toFixed(2)}&cu=INR&aid=uGICAgKDp0aHBGg`;
          const upiLink = document.querySelector('#upi-link');

          if (isMobile) {
            upiLink.href = upiURL;
            upiLink.click();
          } else {
            this.qrAmount = amount.toFixed(2);
            this.qrImage = "/static/images/qr.jpg"; // you can make this dynamic if needed
            this.showQR = true;
          }
        },

        openCancelModal(event) {
          this.cancelForm = event.target;
          this.showCancelModal = true;
        },

        closeCancelModal() {
          this.showCancelModal = false;
          this.cancelForm = null;
        },

        submitCancelForm() {
          if (this.cancelForm) {
            this.cancelForm.submit();
          }
        }
      }
    }
  </script>
</body>
</html>
